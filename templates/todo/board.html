{% extends "todo/base_site.html" %}

{% block extra_head %}
{{ block.super }}
<script type="text/javascript" src="{{MEDIA_URL}}js/jquery/overlay/jquery.hint.js"></script> 
<script type="text/javascript" src="{{MEDIA_URL}}js/jquery/blockui/jquery.blockUI.js"></script> 

<script type="text/javascript">

$(function() {
    kisstodo_board.init_board();
});

var kisstodo_board = (function () {
    var res = {};
    
    res.init_board=function() {

        kisstodo_board.refresh_list_list();
        kisstodo_board.refresh_todo_list(-1);
       
        $('#description').hint();
        $('#description').blur();
        
        $(document).bind('keypress', kisstodo_board.event_keypress);
        $(document).bind('keydown', kisstodo_board.event_keydown);
        
        $('input[type=text]').live('focus', function () {           
            kisstodo_board.select_next_todo(0);
            kisstodo_board.focused_element = $(this).attr('id');
        });
        
        $('input[type=text]').live('blur', function () {           
            kisstodo_board.focused_element = '';
        });
        
        $('.list').live('click', function () { 
            $('.list').removeClass('selected_link').removeClass('selected_list');
            $(this).addClass('selected_link').addClass('selected_list');
            
            var list_id=$('.selected_list').attr('id').replace('list_','');
            
            kisstodo_board.refresh_todo_list(list_id);
    		
            return false;
        });
    
        $('.list_delete').live('click', function () { 
            var list_id=$(this).attr('id').replace('list_delete_','');
            var item = $("#delete_list_form_"+list_id);
            
            var data = {
                csrfmiddlewaretoken: item.find("input:text[name=csrfmiddlewaretoken]").val(),
                list_id: list_id
            };
       
            $.post("{%url todo.views.delete_list%}", data, function (response) {
                    kisstodo_board.refresh_list_list(-1);
                    kisstodo_board.refresh_todo_list(-1);
            });        
    		
            return false;
        });    
    
        $('.todo_delete').live('click', function () { 
            var todo_id=$(this).attr("id").replace("todo_delete_","");
            var todo=$(this).parents("li");
            
            var item = $("#delete_todo_form_"+todo_id);
            
            var data = {
                csrfmiddlewaretoken: item.find("input:text[name=csrfmiddlewaretoken]").val(),
                todo_id: todo_id
            };
            
            $.post("{%url todo.views.delete_todo%}", data, function (response) {
                todo.remove();
            });        
    		
            return false;
        });     

        $('.todo_complete').live('click', function () { 
            var todo_id=$(this).attr("id").replace("todo_complete_","");
            var todo=$(this).parents("li");
            var yesno = $(this).attr("checked");

            var item = $("#delete_todo_form_"+todo_id);
            
            var data = {
                csrfmiddlewaretoken: item.find("input:text[name=csrfmiddlewaretoken]").val(),
                todo_id: todo_id,
                complete: !yesno
            };
            
            $.post("{%url todo.views.complete_todo%}", data, function (response) {
                todo.toggleClass("complete");
            });        
    		
            return true;
        });    
    }
    
    res.refresh_todo_list = function (list_id) {
        //kisstodo_board.lockGui();
        $("#todo_list").fadeOut(kisstodo_board.default_animation_speed);

        $.get("{% url todo.views.list_todo '' %}"+list_id, function(response) {
            $("#todo_list").html(response);
            $("#todo_list").fadeIn(kisstodo_board.default_animation_speed);
            
            $("#add_todo_form").find("#description").focus();
            
            $(".list_delete").hide();
            $("#list_delete_"+list_id).show();
            
            if (list_id==-1) $("#todo_list").html("");
            
            //kisstodo_board.unlockGui();
        });      
    }
    
    res.refresh_list_list = function(selected_list_id) {    
        kisstodo_board.lockGui();
        $("#list_list").fadeOut(kisstodo_board.default_animation_speed);

        $.get("{% url todo.views.list_list '' %}"+selected_list_id, function(response) {
            $("#list_list").html(response);
            
            kisstodo_board.unlockGui();
            $("#list_list").fadeIn(kisstodo_board.default_animation_speed);
        });   
    }    
    
    res.select_next_list = function(increment) {
    
        var lists=$("a.list");
        var selected_list=$("a.selected_list");
        var selected_id=-1;
        var selected_index=-1;
        if ((selected_list).length>0) {
            selected_id=selected_list.attr("id").replace('list_','');
        }
        
        var ids=new Array()

        for (x=0; x<lists.length; x++) {
            ids[x]=$(lists[x]).attr("id").replace('list_','');
            if (ids[x]==selected_id) selected_index=x;
        }
        
        var new_index=selected_index+increment;
        
        if (new_index<0) new_index=0;
        if (new_index <lists.length) {
            new_id=ids[new_index];
            $("#list_"+new_id).click();
        }
    }

    res.lockGui = function() {
        $.blockUI({message:"", overlayCSS:  {
    		backgroundColor: '#000',
    		opacity:	  	 0.1,
    		cursor:		  	 'wait'
    	},css: { backgroundColor: '#fff', color: '#fff'}});
    }

    res.unlockGui = function() {
        $.unblockUI();
    }
    
    res.add_list = function() {
        
        var item = $("#add_list_form");

        var data = {
            csrfmiddlewaretoken: item.find("input:text[name=csrfmiddlewaretoken]").val(),
            name: item.find("#name").val()
        };
        
        if (data.name == '') return false;
        
        item.find("#name").val("");
                
        $.post("{%url todo.views.add_list%}", data, function (response) {
            kisstodo_board.refresh_list_list(response);
            kisstodo_board.refresh_todo_list(response);
        });

        return false;
    }    
    
    res.add_todo = function() {
        var item = $("#add_todo_form");
        var data = {
            csrfmiddlewaretoken: item.find("input:text[name=csrfmiddlewaretoken]").val(),
            description: item.find("#description").val(),
            list_id: item.find("#list_id").val()
        };
        
        if (data.description == '') return false;
                
        $.post("{%url todo.views.add_todo%}", data, function (response) {
            var list_id=$('.selected_list').attr('id').replace('list_','');
            kisstodo_board.refresh_todo_list(list_id);
        });

        return false;
    }
     
    
    res.event_keypress = function(event) {
        
        //alert (event.which);
        
        //  d
        if (event.which == 100) {
           $(".selected_todo .todo_delete img").click();
        }
        
        // c
        if (event.which == 99) {
            $(".selected_todo .todo_complete").click();
        }        
    }

    res.event_keydown = function(event) {  
        
        //alert (event.which);
        
        // ESC
        if (event.which == 27) {
            if (kisstodo_board.operation_pending) return;
            kisstodo_board.select_next_todo(0);
            if (kisstodo_board.focused_element!='') $('#'+kisstodo_board.focused_element).blur();
            
        }        
        
        // UP
        if (event.which == 38) {
            if (kisstodo_board.operation_pending) return;
            
            if (kisstodo_board.focused_element=='name') {
                return;
            }
            
            if (kisstodo_board.focused_element=='description') {
                $('#name').focus();
                return;
            }
            kisstodo_board.select_next_todo(-1);
        }        
        
        // DOWN
        if (event.which == 40) {
            if (kisstodo_board.operation_pending) return;
            
             if (kisstodo_board.focused_element=='name') {
                $('#description').focus();
                return;
            }
            kisstodo_board.select_next_todo(+1);
        }     
        
        // LEFT
        if (event.which == 37) {
            if (kisstodo_board.operation_pending) return;

            if (kisstodo_board.focused_element=='description' && $("#description").val()) {
                return;
            }
            kisstodo_board.select_next_list(-1);
        }    
        
        // RIGHT
        if (event.which == 39) {
            if (kisstodo_board.operation_pending) return;
            
            if (kisstodo_board.focused_element=='description' && $("#description").val()) {
                return;
            }
            kisstodo_board.select_next_list(1);
        }            

    } 
    
    
    res.select_next_todo = function(increment) {
       
        $('.todos li.todo_li').removeClass("selected_todo");
        
        if (increment==0) {
            kisstodo_board.selected_todo_index=-1;
            return;
        }
        
        if (kisstodo_board.focused_element=="description") $('#description').blur();
        
        var selected_todo_index_max=$('.todos li.todo_li').length-1;
                
        kisstodo_board.selected_todo_index+=increment;
        
        if (kisstodo_board.selected_todo_index<0) { kisstodo_board.selected_todo_index=0; $('#description').focus();}
        if (kisstodo_board.selected_todo_index>selected_todo_index_max) { kisstodo_board.selected_todo_index=selected_todo_index_max; }
        
        $('.todos li.todo_li:eq('+kisstodo_board.selected_todo_index+')').addClass("selected_todo");
    }
     
    res.selected_todo_index=0;
    res.operation_pending = false;
    res.focused_element = '';
    
    // CONFIG
    res.default_animation_speed=150;
    
    
    return res; 
}());

</script>
{% endblock %}

{% block content_title %}KissTodo{% endblock %}

{% block content %}

<form method="post" action="." id="add_list_form" onSubmit="return kisstodo_board.add_list()"><input class="big" title="&raquo; CREATE A NEW LIST" size="22" autocomplete="off" type="text" id="name" name="name" />{% csrf_token %}</form>
<div id="list_list" ></div>
<span id="todo_list" ></span>

{% endblock %}