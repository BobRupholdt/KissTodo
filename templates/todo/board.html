{% extends "todo/base_site.html" %}

{% block extra_head %}
{{ block.super }}
<script type="text/javascript" src="{{MEDIA_URL}}js/jquery/overlay/jquery.hint.js"></script> 
<script type="text/javascript" src="{{MEDIA_URL}}js/jquery/blockui/jquery.blockUI.js"></script> 

<script type="text/javascript">

$(function() {
    kisstodo_board.init_board();
});

var kisstodo_board = (function () {
    var res = {};
    
    res.init_board=function() {

        kisstodo_board.refresh_list_list({{inbox_list_id}});
        kisstodo_board.refresh_todo_list({{inbox_list_id}});
       
        $('#description').hint();
        $('#description').blur();
        
        $(document).bind('keypress', kisstodo_board.event_keypress);
        $(document).bind('keydown', kisstodo_board.event_keydown);
        
        $('input[type=text]').live('focus', function () {           
            kisstodo_board.focused_element = $(this).attr('id');
            if (kisstodo_board.focused_element.indexOf('edit_todo_')!=0) kisstodo_board.select_next_todo(0);
        });
        
        $('input[type=text]').live('blur', function () {           
            kisstodo_board.focused_element = '';
        });
        
        $('.list').live('click', function () { 
            $('.list').removeClass('selected_link').removeClass('selected_list');
            $(this).addClass('selected_link').addClass('selected_list');
            
            var list_id=$('.selected_list').attr('id').replace('list_','');
            
            kisstodo_board.refresh_todo_list(list_id);
    		
            return false;
        });
        
        $('.todo_description').live('click', function () { 
            if (kisstodo_board.is_edit_active()) return;
            
            //todo_id=($(this).parents('li').attr('id').replace('todo_li_',''));
            $('.todos li.todo_li').removeClass("selected_todo");
            $($(this).parents('li')).addClass("selected_todo");
            kisstodo_board.edit_selected_todo();
        });        
    
        $('.list_delete').live('click', function () { 
            var list_id=$(this).attr('id').replace('list_delete_','');
            var item = $("#delete_list_form_"+list_id);
            
            var data = {
                list_id: list_id
            };
       
            $.post("{%url todo.views.list_delete%}", data, function (response) {
                    kisstodo_board.refresh_list_list(-1);
                    kisstodo_board.refresh_todo_list(-1);
            });        
    		
            kisstodo_board.show_message("List deleted.");
            return false;
        });   

        $('.list_edit').live('click', function () { 
            var list_id=$(this).attr('id').replace('list_edit_','');
            
            var d = $(".selected_list").parents(".list_item");
            d.fadeOut(kisstodo_board.default_animation_speed);
            
            d.load("{%url todo.views.list_edit ''%}"+list_id, function () {
                d.fadeIn(kisstodo_board.default_animation_speed);
                $('#edit_list_name').focus();
            });
            
            return false;
        });    
        
        $('.todo_delete').live('click', function () { 
            var todo_id=$(this).attr("id").replace("todo_delete_","");
            var todo=$(this).parents("li");
            
            var item = $("#delete_todo_form_"+todo_id);
            
            var data = {
                todo_id: todo_id
            };
            
            $.post("{%url todo.views.todo_delete%}", data, function (response) {
                todo.remove();
            });        
    		
            return false;
        });   

        $('.todo_undelete').live('click', function () { 
            var todo_id=$(this).attr("id").replace("todo_undelete_","");
            var todo=$(this).parents("li");
            
            var item = $("#delete_todo_form_"+todo_id);
            
            var data = {
                todo_id: todo_id
            };
            
            $.post("{%url todo.views.todo_undelete%}", data, function (response) {
                todo.remove();
            });        
    		
            return false;
        });           

        $('.todo_complete').live('click', function () { 
            var todo_id=$(this).attr("id").replace("todo_complete_","");
            var todo=$(this).parents("li");

            var item = $("#delete_todo_form_"+todo_id);
            
            var data = {
                todo_id: todo_id
            };
            
            $.post("{%url todo.views.todo_complete%}", data, function (response) {
                todo.toggleClass("complete");
            });        
    		
            return true;
        });   
        
        $(".help_toggle").hover(
            function(){$('#help').fadeIn(kisstodo_board.default_animation_speed*2);},
            function(){$('#help').fadeOut(kisstodo_board.default_animation_speed*2);}
        );

    }
    
    res.update_todo = function(todo_id, data) {
        data.todo_id=todo_id
            
        $.post("{%url todo.views.todo_edit ''%}"+todo_id, data, function (response) {
            var p=''; 
            if (data.priority<4) p='P'+data.priority;
            $('#todo_li_'+data.todo_id+' .todo_priority').html(p);
        });    
        
    }
    
    res.refresh_todo_list = function (list_id) {
        //kisstodo_board.lockGui();
        $("#todo_list").fadeOut(kisstodo_board.default_animation_speed);

        $.get("{% url todo.views.todo_list '' %}"+list_id, function(response) {
            $("#todo_list").html(response);
            $("#todo_list").fadeIn(kisstodo_board.default_animation_speed);
            
            $("#add_todo_form").find("#description").focus();
            
            $(".list_delete").hide();
            $("#list_delete_"+list_id).show();
            $(".list_edit").hide();
            $("#list_edit_"+list_id).show();
            
            if (list_id==-1) $("#todo_list").html("");
            
            //kisstodo_board.unlockGui();
        });      
    }
    
    res.refresh_list_list = function(selected_list_id) {    
        kisstodo_board.lockGui();
        $("#list_list").fadeOut(kisstodo_board.default_animation_speed);

        $.get("{% url todo.views.list_list '' %}"+selected_list_id, function(response) {
            $("#list_list").html(response);
            
            kisstodo_board.unlockGui();
            $("#list_list").fadeIn(kisstodo_board.default_animation_speed);
        });   
    }    
    
    res.select_next_list = function(increment) {
    
        var lists=$("a.list");
        var selected_list=$("a.selected_list");
        var selected_id=-1;
        var selected_index=-1;
        if ((selected_list).length>0) {
            selected_id=selected_list.attr("id").replace('list_','');
        }
        
        var ids=new Array()

        for (x=0; x<lists.length; x++) {
            ids[x]=$(lists[x]).attr("id").replace('list_','');
            if (ids[x]==selected_id) selected_index=x;
        }
        
        var new_index=selected_index+increment;
        
        if (new_index<0) new_index=0;
        if (new_index <lists.length) {
            new_id=ids[new_index];
            $("#list_"+new_id).click();
        }
    }

    res.lockGui = function() {
        $.blockUI({message:"", overlayCSS:  {
    		backgroundColor: '#000',
    		opacity:	  	 0.1,
    		cursor:		  	 'wait'
    	},css: { backgroundColor: '#fff', color: '#fff'}});
    }

    res.unlockGui = function() {
        $.unblockUI();
    }
    
    res.add_list = function() {
        
        var item = $("#add_list_form");

        var data = {
            name: item.find("#name").val()
        };
        
        if (data.name == '') return false;
        
        item.find("#name").val("");
                
        $.post("{%url todo.views.list_add%}", data, function (response) {
            kisstodo_board.refresh_list_list(response);
            kisstodo_board.refresh_todo_list(response);
        });

        kisstodo_board.show_message("List created.");
        return false;
    }    
    
    res.add_todo = function() {
        var item = $("#add_todo_form");
        var data = {
            description: item.find("#description").val(),
            list_id: item.find("#list_id").val()
        };
        
        if (data.description == '') return false;
                
        $.post("{%url todo.views.todo_add%}", data, function (response) {
            var list_id=$('.selected_list').attr('id').replace('list_','');
            kisstodo_board.refresh_todo_list(list_id);
        });

        return false;
    }     
    
    res.edit_selected_todo = function() {
        if ($(".selected_todo").hasClass('complete')) return;
        
        todo_id=$(".selected_todo").attr("id").replace('todo_li_','');
        var d = $(".selected_todo .todo_item");
        d.fadeOut(kisstodo_board.default_animation_speed);
        d.load("{%url todo.views.todo_edit ''%}"+todo_id, function () {
            d.fadeIn(kisstodo_board.default_animation_speed);
            $('#edit_todo_description').focus();
            //setTimeout( function(){$('#edit_todo_description').select();}, 20);
        });
    }     
    
    res.event_keypress = function(event) {
        
        //console.log ("event_keypress: "+event.which);
        
        // enter
        if (event.which == 13) {
            if (kisstodo_board.is_todo_edit_active()) {
                var todo_id=$(".selected_todo").attr("id").replace('todo_li_','');
                var d = $(".selected_todo .todo_item");
                
                var data = {
                    todo_id: todo_id,
                    description: $('#edit_todo_description').val(),
                    priority: $('#edit_todo_priority').val(),
                    list_id: $('#edit_todo_list_id').val()
                };
                
                $.post("{%url todo.views.todo_edit ''%}"+todo_id, data, function (response) {
                    d.html(response);
                    d.fadeIn(kisstodo_board.default_animation_speed);
                });    
            }
            else if (kisstodo_board.is_list_edit_active()) {
                var list_id=$("#edit_list_name").parents(".list_item").attr("id").replace('list_item_','');
                                
                var data = {name: $('#edit_list_name').val()};
                
                $.post("{%url todo.views.list_edit ''%}"+list_id, data, function (response) {
                    kisstodo_board.refresh_list_list(list_id);
                    kisstodo_board.refresh_todo_list(list_id);
                });                   
            }
            else if ($(".selected_todo").length>0) {
                kisstodo_board.edit_selected_todo();
            }
        }
        
        //  d
        if (event.which == 100) {
            if (kisstodo_board.is_edit_active()) return;
            $(".selected_todo .todo_delete img").click();
        }
        
        // c
        if (event.which == 99) {
            if (kisstodo_board.is_edit_active()) return;
            $(".selected_todo .todo_complete").click();
        }        
        
        // 1..4
        if (event.which >= 49 && event.which<=52) {
            if (kisstodo_board.is_edit_active()) return;
            if ($(".selected_todo").length==0) return;
            var todo_id=$(".selected_todo").attr("id").replace('todo_li_', '');
            kisstodo_board.update_todo(todo_id, {priority:event.which-48});
        }
    }
    
    res.todo_edit_abort = function() {
        var d = $(".selected_todo .todo_item");
        var todo_id=$(".selected_todo").attr("id").replace('todo_li_', '');
        d.fadeOut(kisstodo_board.default_animation_speed);
        d.load("{%url todo.views.todo_show_item '' %}"+todo_id, function () {d.fadeIn(kisstodo_board.default_animation_speed);});      
    }
    
    res.list_edit_abort = function() {
        var list_id=$("#edit_list_name").parents(".list_item").attr("id").replace('list_item_','');
        kisstodo_board.refresh_list_list(list_id);
        kisstodo_board.refresh_todo_list(list_id);
    }    

    res.event_keydown = function(event) {  
        
        //console.log ("event_keydown: "+event.which);
        
        // ESC
        if (event.which == 27) {
            if (kisstodo_board.is_todo_edit_active()) {
                setTimeout(function(){kisstodo_board.todo_edit_abort();}, 1);
            }
            else if (kisstodo_board.is_list_edit_active()) {
                setTimeout(function(){kisstodo_board.list_edit_abort();}, 1);
            }
            else {
                kisstodo_board.select_next_todo(0);
                if (kisstodo_board.focused_element!='') $('#'+kisstodo_board.focused_element).blur();
            }
        }        
        
        // UP
        if (event.which == 38) {
            if (kisstodo_board.is_edit_active()) return; 
            
            if (kisstodo_board.focused_element=='name') return;
            
            if (kisstodo_board.focused_element=='description') {
                $('#name').focus();
                return;
            }
            
            kisstodo_board.select_next_todo(-1);
        }        
        
        // DOWN
        if (event.which == 40) {
            if (kisstodo_board.is_edit_active()) return;
            
            if (kisstodo_board.focused_element=='name' && $('#description').length>0) {
                $('#description').focus();
                return;
            }
             
            kisstodo_board.select_next_todo(+1);
        }     
        
        // LEFT
        if (event.which == 37) {
            if (kisstodo_board.is_edit_active()) return;

            if (kisstodo_board.focused_element=='description' && $("#description").val()) {
                return;
            }
            kisstodo_board.select_next_list(-1);
        }    
        
        // RIGHT
        if (event.which == 39) {
            if (kisstodo_board.is_edit_active()) return;
            
            if (kisstodo_board.focused_element=='description' && $("#description").val()) {
                return;
            }
            kisstodo_board.select_next_list(1);
        }            

    } 
    
    res.select_next_todo = function(increment) {
       
        $('.todos li.todo_li').removeClass("selected_todo");
        
        if (increment==0) {
            kisstodo_board.selected_todo_index=-1;
            return;
        }
        
        if (kisstodo_board.focused_element=="description") $('#description').blur();
        if (kisstodo_board.focused_element=="name") $('#name').blur();
        
        var selected_todo_index_max=$('.todos li.todo_li').length-1;
                
        kisstodo_board.selected_todo_index+=increment;
        
        if (kisstodo_board.selected_todo_index<0) { kisstodo_board.selected_todo_index=0; if ($('#description').length>0) $('#description').focus(); else $('#name').focus();}
        if (kisstodo_board.selected_todo_index>selected_todo_index_max) { kisstodo_board.selected_todo_index=selected_todo_index_max; }
        
        $('.todos li.todo_li:eq('+kisstodo_board.selected_todo_index+')').addClass("selected_todo");
    }
    
    res.is_todo_edit_active = function() {
        return  $('#edit_todo_description').length>0;
    }
    
    res.is_list_edit_active = function() {
        return  $('#edit_list_name').length>0;
    }
    
    res.is_edit_active = function() {
        return  res.is_todo_edit_active() || res.is_list_edit_active();
    }    
    
    res.show_message = function(message) {
        $('#message_text').html(message).fadeIn(kisstodo_board.default_animation_speed*2);
        
        setTimeout(function() {$('#message_text').fadeOut(kisstodo_board.default_animation_speed*2);}, kisstodo_board.long_animation_speed);
    }    
    
    res.selected_todo_index=0;
    res.focused_element = '';
    
    // CONFIG
    res.default_animation_speed=150;
    res.long_animation_speed=1500;
        
    return res; 
}());

</script>
{% endblock %}

{% block content_title %}KissTodo {% endblock %}
{% block content_headline%}<span class="no_background"><a class="help_toggle" href="#"><img src="{{MEDIA_URL}}img/help.png" /></a></span>
<div id="help" style="display:none;">
    <table>
    <tr><th colspan="2">Special, not deletable lists</th></tr>
    <tr><td colspan="2"><b>@inbox</b>: when you delete a list, all todo are moved to @inbox.</td></tr>
    <tr><td colspan="2"><b>@hot</b>: a list containing all todo with a priority.</td></tr>
    <tr><td colspan="2"><b>@trash</b>: when you delete a todo, it is moved into @trash list. You can un-delete the todo by clicking on the <img src="{{MEDIA_URL}}img/undo.png" /> icon.</td></tr>
    </table>
    
    <table>
    <tr><th colspan="2">Keyboard shortcuts</th></tr>
    <tr><td><span class="kbd">&larr;</span> / <span class="kbd">&rarr;</span></td><td>select prev. / next list</td></td>
    <tr><td><span class="kbd">&uarr;</span> / <span class="kbd">&darr;</span></td><td>select prev. / next todo</td></td>
    <tr><td><span class="kbd">1</span> .. <span class="kbd">4</span></td><td>change todo priority<br/><span class="small">1 = max, 4 = none</span></td></td>
    <tr><td><span class="kbd">c</span></td><td>(un)complete selected todo</td></td>
    <tr><td><span class="kbd">d</span></td><td>delete selected todo</td></td>
    <tr><td><span class="kbd">ENTER</span></td><td>edit / save selected todo</td></td>
    <tr><td><span class="kbd">ESC</span></td><td>cancel current edit</td></td>
    </table>
</div>
{{ block.super }}
{% endblock %}
{% block content %}
<form method="post" action="." id="add_list_form" onSubmit="return kisstodo_board.add_list()">
<input class="big" title="&raquo; CREATE A NEW LIST" size="22" autocomplete="off" type="text" id="name" name="name" /></form>
<div id="list_list" ></div>
<span id="todo_list" ></span>

{% endblock %}